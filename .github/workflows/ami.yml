name: AMI Update

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'
  push:
    branches:
      - '*'  # This will trigger for pushes to any branch

jobs:
  compare-ami:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [sit, uat, ops]

    name: Compare AMI for ${{ matrix.env }}

    steps:

      - name: Set environment variables
        run: |
          echo "UPPERCASE=${{ matrix.env }}" >> $GITHUB_ENV
          echo "lowercase=$(echo "${{ matrix.env }}" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets[format('AWS_ACCESS_KEY_ID_SERVICES_{0}', env.UPPERCASE)] }}
          aws-secret-access-key: ${{ secrets[format('AWS_SECRET_ACCESS_KEY_SERVICES_{0}', env.UPPERCASE)] }}
          aws-region: us-west-2  # change this if needed

      - name: Get deployed AMI ID
        id: deployed
        run: |
          TAG_NAME="${{ env.lowercase }}-hitide-backfill-tool-CumulusECSCluster"
          DEPLOYED_AMI=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=$TAG_NAME" \
            --query "Reservations[].Instances[].ImageId" \
            --output text | tr '\t' '\n' | sort | uniq)
          echo "Deployed AMI for $TAG_NAME: $DEPLOYED_AMI"
          echo "ami_id=$DEPLOYED_AMI" >> "$GITHUB_OUTPUT"

      - name: Get SSM AMI ID
        id: ssm
        run: |
          SSM_PARAM="/ngap/amis/image_id_ecs_al2023_x86"
          PARAM_AMI=$(aws ssm get-parameter \
            --name "$SSM_PARAM" \
            --with-decryption \
            --query "Parameter.Value" \
            --output text)
          echo "SSM AMI for $SSM_PARAM: $PARAM_AMI"
          echo "ami_id=$PARAM_AMI" >> "$GITHUB_OUTPUT"

      - name: Compare AMI IDs
        id: compare
        run: |
          DEPLOYED="${{ steps.deployed.outputs.ami_id }}"
          EXPECTED="${{ steps.ssm.outputs.ami_id }}"

          echo "Comparing for ${{ matrix.env }}:"
          echo "Deployed: $DEPLOYED"
          echo "Expected: $EXPECTED"

          if [ "$DEPLOYED" != "$EXPECTED" ]; then
            echo "❌ AMI Mismatch in ${{ matrix.env }}!"
            echo "mismatch=true" >> $GITHUB_OUTPUT
          else
            echo "✅ AMI Match for ${{ matrix.env }}!"
            echo "mismatch=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout appropriate branch
        if: steps.compare.outputs.mismatch == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ 
            matrix.env == 'sit' && 'develop' ||
            matrix.env == 'ops' && 'main' ||
            'placeholder'
          }}

      - name: Check for release branch (UAT only)
        if: matrix.env == 'uat' && steps.compare.outputs.mismatch == 'true'
        id: check-release
        run: |
          git fetch --all
          if git ls-remote --heads origin 'release/*' | grep .; then
            RELEASE_BRANCH=$(git ls-remote --heads origin 'release/*' | sort -t '/' -k 3 -V | tail -n 1 | awk '{print $2}' | sed 's/refs\/heads\///')
            echo "branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
          fi

      - name: Checkout UAT branch
        if: matrix.env == 'uat' && steps.compare.outputs.mismatch == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.check-release.outputs.branch }}



